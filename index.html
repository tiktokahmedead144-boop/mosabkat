<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; user-select: none; }
        .hidden { display: none !important; }
        .modal-animate { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .locked-item { opacity: 0.7; filter: grayscale(90%); cursor: not-allowed; position: relative; }
        .locked-item::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-size: 2rem; color: #ef4444; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .opt-btn { width: 100%; padding: 1.25rem; border: 2px solid #e2e8f0; border-radius: 1rem; font-weight: bold; transition: all 0.2s; background: white; text-align: right; }
        .opt-btn:hover:not(:disabled) { border-color: #10b981; background: #ecfdf5; }
        .correct { background: #d1fae5 !important; border-color: #10b981 !important; color: #065f46; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <div id="loading" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-slate-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <div id="app-banner" class="hidden p-3 bg-gradient-to-r from-blue-900 to-blue-700 text-white sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-4">
            <span class="font-bold text-xs md:text-sm" id="ui-app-text"></span>
            <a id="ui-app-link" href="#" target="_blank" class="bg-yellow-400 text-blue-900 px-4 py-1 rounded-full text-xs font-black">ØªØ­Ù…ÙŠÙ„</a>
        </div>
    </div>

    <nav class="bg-white border-b-4 border-emerald-500 p-4 shadow-sm relative z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-black text-emerald-800 cursor-pointer" onclick="location.reload()">
                <i class="fas fa-graduation-cap"></i> <span id="ui-site-name">Ø§Ù„Ù…Ù†ØµØ©</span>
            </h1>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 space-y-8">
        
        <section id="landing" class="view-section hidden space-y-10">
            <div class="text-center space-y-3">
                <h2 class="text-4xl md:text-6xl font-black text-slate-900" id="ui-hero-title"></h2>
                <p class="text-slate-500 font-bold text-xl" id="ui-hero-desc"></p>
            </div>

            <div id="ui-tutorial-box" class="hidden bg-blue-50 border-r-8 border-blue-600 p-6 rounded-2xl max-w-3xl mx-auto shadow-sm">
                <p id="ui-tutorial-text" class="font-bold text-slate-700 leading-relaxed"></p>
            </div>

            <div id="ui-ext-link-area" class="hidden text-center">
                <a id="ui-ext-link" href="#" target="_blank" class="inline-flex items-center gap-2 bg-yellow-400 text-slate-900 px-8 py-3 rounded-full font-black shadow-lg hover:scale-105 transition-all">
                    <i class="fas fa-link"></i> <span id="ui-ext-text"></span>
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div onclick="app.enterVisitor()" class="bg-white p-8 rounded-[2.5rem] shadow-xl border-b-[8px] border-slate-300 cursor-pointer hover:-translate-y-2 transition-all text-center">
                    <i class="fas fa-user text-5xl text-slate-400 mb-4"></i>
                    <h3 class="text-2xl font-black text-slate-700" id="ui-btn-vis">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</h3>
                </div>
                <div onclick="app.enterSubscriber()" class="bg-white p-8 rounded-[2.5rem] shadow-xl border-b-[8px] border-emerald-500 cursor-pointer hover:-translate-y-2 transition-all text-center">
                    <i class="fas fa-crown text-5xl text-emerald-500 mb-4"></i>
                    <h3 class="text-2xl font-black text-emerald-700" id="ui-btn-sub">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
                </div>
            </div>
        </section>

        <section id="dashboard" class="view-section hidden space-y-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center">
                <button onclick="app.showSection('landing')" class="bg-slate-100 px-4 py-2 rounded-xl font-bold text-xs text-slate-500">Ø®Ø±ÙˆØ¬</button>
                <span id="user-status" class="font-black text-xs"></span>
            </div>

            <div id="simulations-list" class="space-y-4"></div>

            <div class="text-center"><h2 class="text-3xl font-black text-slate-800">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2></div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 gap-5">
                <button onclick="app.selectMajor('Competition')" class="col-span-2 md:col-span-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white p-6 rounded-3xl shadow-lg border-b-8 border-orange-800 hover:scale-[1.01] transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-trophy text-3xl text-yellow-200"></i>
                    <div class="text-right"><span class="block font-black text-xl">Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆÙ…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©</span></div>
                </button>
                <button onclick="app.selectMajor('Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©')" class="bg-white p-6 rounded-3xl shadow border-b-8 border-emerald-500 font-black text-lg hover:-translate-y-1 transition-all">Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©</button>
                <button onclick="app.selectMajor('Ø±ÙŠØ§Ø¶ÙŠØ§Øª')" class="bg-white p-6 rounded-3xl shadow border-b-8 border-blue-600 font-black text-lg hover:-translate-y-1 transition-all">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
                <button onclick="app.selectMajor('Ø¹Ù„ÙˆÙ…')" class="bg-white p-6 rounded-3xl shadow border-b-8 border-purple-600 font-black text-lg hover:-translate-y-1 transition-all">Ø¹Ù„ÙˆÙ…</button>
                <button onclick="app.selectMajor('Ø¯Ø±Ø§Ø³Ø§Øª')" class="bg-white p-6 rounded-3xl shadow border-b-8 border-amber-500 font-black text-lg hover:-translate-y-1 transition-all">Ø¯Ø±Ø§Ø³Ø§Øª</button>
                <button onclick="app.selectMajor('Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©')" class="bg-white p-6 rounded-3xl shadow border-b-8 border-rose-500 font-black text-lg hover:-translate-y-1 transition-all">English</button>
            </div>
        </section>

        <section id="sub-dashboard" class="view-section hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <button onclick="app.showSection('dashboard')" class="text-blue-600 font-bold text-sm">ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…</button>
                <h3 id="major-title" class="font-black text-xl"></h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="app.selectMinor('ØªØ®ØµØµ')" class="md:col-span-2 lg:col-span-3 p-8 bg-slate-800 text-white rounded-3xl shadow-xl border-r-[8px] border-yellow-400 flex justify-between items-center hover:bg-slate-900 transition-all">
                    <div class="text-right"><h4 class="text-2xl font-black mb-1">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ®ØµØµ</h4></div><i class="fas fa-star text-4xl text-yellow-400"></i>
                </button>
                <button onclick="app.selectMinor('ØªØ±Ø¨ÙˆÙŠ')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">Ø§Ù„ØªØ±Ø¨ÙˆÙŠ</button>
                <button onclick="app.selectMinor('Ø¬Ø¯Ø§Ø±Ø§Øª')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">Ø§Ù„Ø¬Ø¯Ø§Ø±Ø§Øª</button>
                <button onclick="app.selectMinor('IQ')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">IQ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡</button>
                <button onclick="app.selectMinor('Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
                <button onclick="app.selectMinor('Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
                <button onclick="app.selectMinor('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©')" class="p-5 bg-white rounded-2xl shadow font-bold hover:bg-slate-50">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©</button>
            </div>
        </section>

        <section id="content-list" class="view-section hidden space-y-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="app.showSection('sub-dashboard')" class="bg-slate-200 px-4 py-2 rounded-xl font-bold text-sm">Ø±Ø¬ÙˆØ¹</button>
                <h3 id="list-title" class="font-black text-lg text-emerald-800"></h3>
            </div>
            <div id="files-box" class="hidden">
                <h4 class="font-black text-red-600 mb-3 flex items-center gap-2"><i class="fas fa-folder-open"></i> Ø§Ù„Ù…Ù„ÙØ§Øª:</h4>
                <div id="files-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div id="quizzes-box">
                <h4 class="font-black text-blue-600 mb-3 flex items-center gap-2"><i class="fas fa-list-check"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h4>
                <div id="quizzes-grid" class="space-y-4"></div>
            </div>
        </section>

        <section id="exam-player" class="view-section hidden max-w-2xl mx-auto space-y-6">
            <div class="bg-white p-4 rounded-3xl shadow-lg border-t-8 border-emerald-500 sticky top-20 z-30">
                <div class="flex justify-between mb-2">
                    <span id="timer-display" class="font-black text-red-500 text-lg hidden">00:00</span>
                    <span id="progress-text" class="text-xs font-black text-emerald-600"></span>
                    <button onclick="location.reload()" class="text-xs font-bold text-red-400">Ø®Ø±ÙˆØ¬</button>
                </div>
                <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div id="question-box"></div>
            <div id="result-box" class="hidden bg-white p-10 rounded-[3rem] shadow-2xl text-center border-t-[10px] border-emerald-600">
                <i class="fas fa-award text-6xl text-yellow-400 mb-6 block animate-bounce"></i>
                <h2 class="text-3xl font-black mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
                <p id="res-score" class="text-6xl font-black text-slate-800 mb-8"></p>
                <button onclick="location.reload()" class="bg-slate-900 text-white px-10 py-4 rounded-full font-black text-xl shadow-lg hover:bg-black">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            </div>
        </section>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-50 flex justify-between items-center px-6">
        <p id="footer-text" class="text-xs font-bold text-slate-400"></p>
        <a id="phone-link" href="#" class="flex items-center gap-2 text-emerald-600 font-black">
            <span id="phone-display"></span> <i class="fab fa-whatsapp text-xl"></i>
        </a>
    </footer>

    <div id="password-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm text-center shadow-2xl modal-animate">
            <i class="fas fa-lock text-4xl text-emerald-500 mb-4"></i>
            <h3 class="text-2xl font-black mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
            <p class="text-slate-500 text-sm mb-6 font-bold">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„ÙØªØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
            <input type="password" id="user-pass" class="w-full border-2 border-slate-200 p-4 rounded-xl text-center text-2xl font-black mb-4 outline-none focus:border-emerald-500">
            <button onclick="app.checkPassword()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black shadow-lg">ØªÙØ¹ÙŠÙ„</button>
            <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="mt-4 text-slate-400 font-bold text-sm">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDvFOWeYV2grWux_Z-nl3uFiTR2Jd9UlvE",
            authDomain: "tgrep-11831.firebaseapp.com",
            databaseURL: "https://tgrep-11831-default-rtdb.firebaseio.com",
            projectId: "tgrep-11831",
            storageBucket: "tgrep-11831.firebasestorage.app",
            messagingSenderId: "129365723816",
            appId: "1:129365723816:web:be1fb88079c9a38ac2d09d"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let db = { quizzes: [], files: [], simulations: [], settings: {} };
        let state = { isVIP: false, major: '', minor: '', quiz: null, score: 0, qIdx: 0, timerInterval: null };

        const app = {
            init: () => {
                database.ref('edu_platform_data').on('value', snap => {
                    document.getElementById('loading').classList.add('hidden');
                    if(snap.val()) db = snap.val();
                    app.renderUI();
                });
            },
            renderUI: () => {
                const s = db.settings || {};
                const els = {
                    'ui-site-name': s.siteName, 'ui-hero-title': s.heroTitle, 'ui-hero-desc': s.heroDesc,
                    'footer-text': s.footerText, 'phone-display': s.whatsapp, 'ui-app-text': s.appText,
                    'ui-ext-text': s.extLinkText, 'ui-btn-vis': s.btnVisitor, 'ui-btn-sub': s.btnSub,
                };
                for(let k in els) if(document.getElementById(k)) document.getElementById(k).innerText = els[k] || "";
                document.getElementById('phone-link').href = `https://wa.me/${s.whatsapp}`;
                
                // Fix for Tutorials Visibility
                if(s.tutorialText && s.tutorialText.trim() !== "") {
                    document.getElementById('ui-tutorial-box').classList.remove('hidden');
                    document.getElementById('ui-tutorial-text').innerText = s.tutorialText;
                } else {
                    document.getElementById('ui-tutorial-box').classList.add('hidden');
                }

                if(s.extLinkUrl) { document.getElementById('ui-ext-link-area').classList.remove('hidden'); document.getElementById('ui-ext-link').href = s.extLinkUrl; }
                if(s.appLink) { document.getElementById('app-banner').classList.remove('hidden'); document.getElementById('ui-app-link').href = s.appLink; }
                
                // Render Simulations List
                const simList = document.getElementById('simulations-list');
                simList.innerHTML = "";
                if(db.simulations && db.simulations.length) {
                    db.simulations.forEach(sim => {
                        const locked = sim.mode === 'subscriber' && !state.isVIP;
                        simList.innerHTML += `
                        <div onclick="app.startSimulation(${sim.id}, ${locked})" class="w-full bg-slate-800 text-white p-5 rounded-[2rem] shadow-lg border-l-8 border-yellow-400 cursor-pointer hover:-translate-y-1 transition-all ${locked?'locked-item':''}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-stopwatch text-3xl text-yellow-400"></i>
                                    <div><h3 class="text-xl font-black">${sim.name}</h3><p class="text-xs text-slate-400 font-bold">${sim.time} Ø¯Ù‚ÙŠÙ‚Ø©</p></div>
                                </div>
                                <i class="fas ${locked?'fa-lock text-red-500':'fa-play text-green-400'} text-xl"></i>
                            </div>
                        </div>`;
                    });
                }
                app.showSection('landing');
            },
            showSection: (id) => { document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); },
            enterVisitor: () => { state.isVIP = false; app.updateStatus(); app.showSection('dashboard'); },
            enterSubscriber: () => document.getElementById('password-modal').classList.remove('hidden'),
            checkPassword: () => {
                if(document.getElementById('user-pass').value === (db.settings.accessCode || "123")) {
                    state.isVIP = true; document.getElementById('password-modal').classList.add('hidden');
                    app.updateStatus(); alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ…"); app.showSection('dashboard');
                    if(!document.getElementById('content-list').classList.contains('hidden')) app.selectMinor(state.minor);
                    app.renderUI(); 
                } else alert("ÙƒÙˆØ¯ Ø®Ø·Ø£");
            },
            updateStatus: () => document.getElementById('user-status').innerText = state.isVIP ? "Ù…Ø´ØªØ±Ùƒ VIP ğŸ‘‘" : "Ø²Ø§Ø¦Ø± (Ù…Ø­Ø¯ÙˆØ¯)",
            selectMajor: (m) => { state.major = m; if(m==='Competition') app.selectMinor('Ù…Ù„ÙØ§Øª'); else app.showSection('sub-dashboard'); },
            selectMinor: (m) => {
                state.minor = m;
                document.getElementById('list-title').innerText = m === 'ØªØ®ØµØµ' ? `ØªØ®ØµØµ ${state.major}` : m;
                const isUniversal = ['ØªØ±Ø¨ÙˆÙŠ', 'Ø¬Ø¯Ø§Ø±Ø§Øª', 'IQ', 'Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹', 'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹', 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©'].includes(m);
                
                // FILES
                const files = (db.files||[]).filter(f => {
                    if(state.major==='Competition') return f.major==='Competition';
                    if(isUniversal) return f.minor===m;
                    return f.major===state.major && f.minor===m;
                });
                const fBox = document.getElementById('files-box');
                if(files.length) {
                    fBox.classList.remove('hidden');
                    document.getElementById('files-grid').innerHTML = files.map(f => {
                        const locked = f.mode === 'subscriber' && !state.isVIP;
                        return `<div onclick="app.openFile('${f.url}', ${locked})" class="bg-white p-5 rounded-2xl shadow flex justify-between items-center cursor-pointer ${locked?'locked-item':''}"><div class="flex items-center gap-2"><i class="fas fa-file-pdf text-red-500"></i> <span class="font-bold text-sm">${f.name}</span></div><i class="fas ${locked?'fa-lock text-slate-400':'fa-download text-slate-300'}"></i></div>`;
                    }).join('');
                } else fBox.classList.add('hidden');

                // QUIZZES
                const qBox = document.getElementById('quizzes-box');
                if(state.major==='Competition') qBox.classList.add('hidden');
                else {
                    const quizzes = (db.quizzes||[]).filter(q => {
                        if(isUniversal) return q.minor===m;
                        return q.major===state.major && q.minor===m;
                    });
                    if(quizzes.length) {
                        qBox.classList.remove('hidden');
                        document.getElementById('quizzes-grid').innerHTML = quizzes.map(q => {
                            const locked = q.mode === 'subscriber' && !state.isVIP;
                            return `<div onclick="app.startQuiz(${q.id}, ${locked})" class="bg-white p-5 rounded-2xl shadow flex justify-between items-center cursor-pointer ${locked?'locked-item':''}"><div><h4 class="font-bold">${q.name}</h4><p class="text-[10px] text-slate-400 font-bold">${q.questions?.length||0} Ø³Ø¤Ø§Ù„</p></div><i class="fas ${locked?'fa-lock text-red-500':'fa-play-circle text-blue-500'} text-2xl"></i></div>`;
                        }).join('');
                    } else {
                        document.getElementById('quizzes-grid').innerHTML = '<p class="text-center text-slate-400 font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>';
                        qBox.classList.remove('hidden');
                    }
                }
                app.showSection('content-list');
            },
            openFile: (url, locked) => locked ? document.getElementById('password-modal').classList.remove('hidden') : window.open(url, '_blank'),
            startQuiz: (id, locked) => {
                if(locked) return document.getElementById('password-modal').classList.remove('hidden');
                const q = db.quizzes.find(x => x.id === id);
                if(!q.questions || !q.questions.length) return alert("ÙØ§Ø±Øº");
                state.quiz = q; state.score = 0; state.qIdx = 0;
                document.getElementById('timer-display').classList.add('hidden');
                app.showSection('exam-player'); app.renderQ();
            },
            startSimulation: (id, locked) => {
                if(locked) return document.getElementById('password-modal').classList.remove('hidden');
                const sim = db.simulations.find(x => x.id === id);
                if(!sim) return;
                
                let pool = { 'ØªØ®ØµØµ':[], 'ØªØ±Ø¨ÙˆÙŠ':[], 'Ø¬Ø¯Ø§Ø±Ø§Øª':[], 'IQ':[], 'Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹':[], 'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹':[], 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©':[] };
                (db.quizzes||[]).forEach(q => {
                    if(q.questions && q.questions.length) {
                        if(pool[q.minor]) pool[q.minor].push(...q.questions);
                        else pool['ØªØ®ØµØµ'].push(...q.questions);
                    }
                });
                
                const shuffle = arr => arr.sort(() => 0.5 - Math.random());
                let finalQs = [];
                ['spec','ped','comp','iq','ar','en','gen'].forEach(k => {
                    const key = {'spec':'ØªØ®ØµØµ','ped':'ØªØ±Ø¨ÙˆÙŠ','comp':'Ø¬Ø¯Ø§Ø±Ø§Øª','iq':'IQ','ar':'Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹','en':'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹','gen':'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©'}[k];
                    if(pool[key]) finalQs.push(...shuffle(pool[key]).slice(0, sim.counts[k]||0));
                });
                
                if(!finalQs.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ©");
                state.quiz = { questions: shuffle(finalQs) }; state.score = 0; state.qIdx = 0;
                app.startTimer(sim.time);
                app.showSection('exam-player'); app.renderQ();
            },
            startTimer: (min) => {
                const d = document.getElementById('timer-display'); d.classList.remove('hidden');
                let t = min * 60;
                if(state.timerInterval) clearInterval(state.timerInterval);
                state.timerInterval = setInterval(() => {
                    d.innerText = `${Math.floor(t/60)}:${t%60<10?'0'+t%60:t%60}`;
                    if(t-- <= 0) { clearInterval(state.timerInterval); alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª"); app.finishExam(); }
                }, 1000);
            },
            renderQ: () => {
                document.getElementById('question-box').classList.remove('hidden');
                document.getElementById('result-box').classList.add('hidden');
                const q = state.quiz.questions[state.qIdx];
                document.getElementById('progress-text').innerText = `${state.qIdx+1}/${state.quiz.questions.length}`;
                document.getElementById('progress-bar').style.width = ((state.qIdx+1)/state.quiz.questions.length*100)+"%";
                document.getElementById('question-box').innerHTML = `<div class="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-6"><h3 class="font-black text-xl leading-relaxed text-slate-800">${q.text}</h3><div class="grid gap-3">${q.opts.map((o,i)=>`<button onclick="app.ans(${i},this)" class="opt-btn">${o}</button>`).join('')}</div></div>`;
            },
            ans: (i, btn) => {
                const q = state.quiz.questions[state.qIdx];
                document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
                if(i === parseInt(q.correctAnswer)) { btn.classList.add('correct'); state.score++; }
                else { btn.classList.add('wrong'); document.querySelectorAll('.opt-btn')[parseInt(q.correctAnswer)].classList.add('correct'); }
                setTimeout(() => { if(++state.qIdx < state.quiz.questions.length) app.renderQ(); else app.finishExam(); }, 1500);
            },
            finishExam: () => {
                if(state.timerInterval) clearInterval(state.timerInterval);
                document.getElementById('question-box').classList.add('hidden');
                document.getElementById('result-box').classList.remove('hidden');
                document.getElementById('res-score').innerText = Math.round(state.score/state.quiz.questions.length*100)+"%";
            }
        };
        app.init();
    </script>

</body></html>